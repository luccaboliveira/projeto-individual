<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Usuário - PetPlanner</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="shortcut icon" href="assets/logo-gato-branco.png" type="image/x-icon">
</head>

<body onload="listarPet(), listarTarefa()">
    <div class="header">
        <div class="container">
            <a href="index.html">
                <div class="logo">
                    <img src="assets/logo-branco.png" alt="">
                </div>
            </a>
            <ul class="navbar">
                <li>
                    <a href="home-usuario.html" class="selecionado">Página inicial</a>
                </li>
                <li>
                    <a href="cadastro-pet.html">Cadastrar pet</a>
                </li>
                <li>
                    <button class="btn-sair" onclick="limparSessao()">Sair</button>
                </li>
            </ul>
        </div>
    </div>

    <div class="home">
        <div class="container">
            <h1>Bem vindo(a), <span id="b_usuario">usuário</span>!</h1>
            <div class="container-botao">
                <a href="cadastro-pet.html"><button class="botao btn-azul-linha">Cadastrar novo pet</button></a>
                <a href="#"><button class="botao btn-azul-linha">Acessar dashboard</button></a>
            </div>
            <div class="lista-tarefas">
                <h2>Lista de tarefas</h2>
                <div class="container-campos">
                    <div class="campos-tarefa">
                        <label for="ipt_categoria">Categoria</label>
                        <input type="text" id="ipt_categoria" class="ipt-campo" placeholder="Categoria">
                    </div>

                    <div class="campos-tarefa">
                        <label for="ipt_descricao">Descrição</label>
                        <input type="text" id="ipt_descricao" class="ipt-campo" placeholder="Descrição">
                    </div>

                    <div class="campos-tarefa">
                        <label for="ipt_data">Data de conclusão</label>
                        <input type="date" id="ipt_data" class="ipt-campo">
                    </div>

                    <div class="campos-tarefa">
                        <label for="select_animal">Pet</label>
                        <select class="lista" id="select_animal">
                        </select>
                    </div>

                    <button class="botao btn-azul btn-tarefa" onclick="adicionarTarefa()">Cadastrar nova tarefa</button>
                </div>

                <div class="div-tabela">
                    <table id="tabela">
                        <tr>
                            <th>Categoria</th>
                            <th>Descrição</th>
                            <th>Data</th>
                            <th>Animal</th>
                            <th>Status</th>
                        </tr>
                    </table>
                    <p id="p_mensagem">Insira uma tarefa nos campos acima!</p>
                </div>
            </div>

            <h2>Seus pets</h2>
            <div class="card-pets">
                <div class="card">
                    <div class="img">
                        <img src="assets/exemplo-gato.png" alt="">
                    </div>
                    <h1>Nome do pet</h1>
                </div>

            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="logo">
                <img src="assets/logo-branco.png" alt="">
            </div>
        </div>
    </div>
</body>

</html>
<script>

    var nomeUsuario = sessionStorage.NOME_USUARIO
    var idUsuario = sessionStorage.ID_USUARIO

    b_usuario.innerHTML = nomeUsuario

    function listarPet() {
        fetch("/tarefa/listarPet", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkUsuarioServer: idUsuario
            })
        })
            .then(function (resposta) {
                console.log("resposta: ", resposta);
                if (resposta.ok) {
                    resposta.json().then(json => {
                        var tamanho_lista = json.length;
                        var estrutura = '<option value="#">Selecione um pet</option>';

                        for (var i = 0; i < tamanho_lista; i++) {
                            var id_pet = json[i].id_pet;
                            var nome = json[i].nome;

                            estrutura +=
                                `<option value="${id_pet}">${nome}</option>`;
                        }
                        select_animal.innerHTML = estrutura;
                    });

                } else {
                    console.log('Pets não listados!');
                }
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        return false;
    }

    function adicionarTarefa() {

        console.log(ipt_data.value)

        p_mensagem.innerHTML = ``

        // seleciona o elemento com id tabela no html
        var tabelaTarefas = document.getElementById('tabela')

        // insere linha na tabela = parametro -1 garante que a linha vai sempre na ultima posiçao
        var linha = tabelaTarefas.insertRow(-1)

        // insere celula na posiçao 0 (tipo) da linha
        var celulaCategoria = linha.insertCell(0)
        var celulaDescricao = linha.insertCell(1)
        var celulaData = linha.insertCell(2)
        var celulaAnimal = linha.insertCell(3)
        var celulaStatus = linha.insertCell(4)

        // preenche as celulas de acordo com as entradas do usuário
        celulaCategoria.innerText = ipt_categoria.value
        celulaDescricao.innerText = ipt_descricao.value
        celulaData.innerText = ipt_data.value
        celulaAnimal.innerText = ipt_animal.value
        celulaStatus.innerHTML = `
        <select class="lista" id="select_status">
            <option value="">Pendente</option>
            <option value="">Concluído</option>
            </select>
        `
    }

    function listarTarefa() {
        var id_usuario = sessionStorage.ID_USUARIO

        fetch("/tarefa/listarTarefa", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkUsuarioServer: id_usuario
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listarTarefa()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    // seleciona o elemento com id tabela no html
                    var tabelaTarefas = document.getElementById('tabela')

                    var tamanho_lista = json.length;

                    for (var i = 0; i < tamanho_lista; i++) {
                        var id_tarefa = json[i].id_tarefa
                        var categoria = json[i].categoria
                        var descricao = json[i].descricao
                        var data = json[i].data_final
                        var data_final = data.slice(0,10)
                        var nome = json[i].nome
                        var status_atual = json[i].status_atual
                        
                        // insere linha na tabela = parametro -1 garante que a linha vai sempre na ultima posiçao
                        var linha = tabelaTarefas.insertRow(-1)
    
                        // insere celula na posiçao 0 (tipo) da linha
                        var celulaCategoria = linha.insertCell(0)
                        var celulaDescricao = linha.insertCell(1)
                        var celulaData = linha.insertCell(2)
                        var celulaAnimal = linha.insertCell(3)
                        var celulaStatus = linha.insertCell(4)
    
                        // preenche as celulas de acordo com as entradas do usuário
                        celulaCategoria.innerText = categoria
                        celulaDescricao.innerText = descricao
                        celulaData.innerText = data_final
                        celulaAnimal.innerText = nome
                        celulaStatus.innerHTML = `
                        <select class="lista" onchange="atualizarStatus(${id_tarefa})" id="select_status${id_tarefa}">
                            <option>Pendente</option>
                            <option>Concluído</option>
                        </select>
                        `
                    }

                });

            } else {
                console.log("Houve um erro ao tentar listar as tarefas!");

                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;

    }

    function limparSessao() {
        sessionStorage.clear();
        window.location = "../login.html";
    }
</script>